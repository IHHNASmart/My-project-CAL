OBJECT Page 50004 Out of Office Request Doc
{
  OBJECT-PROPERTIES
  {
    Date=16.06.22;
    Time=20:57:11;
    Modified=Yes;
    Version List=;
  }
  PROPERTIES
  {
    SourceTable=Table50002;
    DataCaptionFields=Entry No,Employee No.,Status;
    PageType=Document;
    PromotedActionCategoriesML=[RUS=Cat1,Изменить статус,Файлы,Cat4;
                                ENG=Cat1,Change status,Files,Cat4];
    OnInit=BEGIN

               //MESSAGE('OnInit DOC');
               //open1
               UserSetupTrue := UserSetup.GET(USERID);
               UserSetupHR   := UserSetup."HR administrator";
               EditablePage  := TRUE;

           END;

    OnOpenPage=BEGIN
                   //MESSAGE('OnOpenPage DOC');
                   //open2

               END;

    OnClosePage=BEGIN
                    //MESSAGE('OnClosePage DOC');
                    //close2
                    // OK record 4
                END;

    OnNextRecord=BEGIN
                     //MESSAGE('OnNextRecord DOC');
                 END;

    OnAfterGetRecord=BEGIN
                         //MESSAGE('OnAfterGetRecord DOC');
                         //open view 4 //3 OnFindRecord
                     END;

    OnNewRecord=BEGIN

                    //MESSAGE('OnNewRecord DOC');

                    //IF "Employee No." = '' THEN
                    SetDefaultEmployee;
                    "Start Date"    := WORKDATE;
                    "End Date"      := WORKDATE;


                    //"Start Date" :=
                    //open3
                END;

    OnInsertRecord=BEGIN
                       //MESSAGE('OnInsertRecord DOC');
                   END;

    OnModifyRecord=BEGIN
                       //MESSAGE('OnModifyRecord DOC');
                       // OK record 1

                       //VALIDATE("Start Date");
                       //VALIDATE("Start Time");
                   END;

    OnDeleteRecord=BEGIN
                       //MESSAGE('OnDeleteRecord DOC');
                   END;

    OnQueryClosePage=BEGIN
                         //MESSAGE('OnQueryClosePage DOC');
                         //close1
                         // OK record 3
                     END;

    OnAfterGetCurrRecord=BEGIN
                             //MESSAGE('OnAfterGetCurrRecord DOC');

                             SettingVisibility;
                             //open4 //open view 5
                         END;

    ActionList=ACTIONS
    {
      { 20      ;0   ;ActionContainer;
                      CaptionML=[ENU=Change status;
                                 RUS=Изменить статус];
                      ActionContainerType=ActionItems }
      { 19      ;1   ;Action    ;
                      Name=Start process;
                      CaptionML=[ENU=Start process;
                                 RUS=Начать процесс];
                      Promoted=Yes;
                      PromotedIsBig=Yes;
                      PromotedCategory=Process;
                      PromotedOnly=Yes;
                      OnAction=BEGIN

                                   //'In process';
                                   IF xRec.Status = xRec.Status::"In process" THEN
                                     EXIT;

                                   IF NOT CheckUserAccess(xRec.Status::"In process") THEN
                                     EXIT;

                                   IF CONFIRM(textSet, FALSE, FORMAT(xRec.Status::"In process")) THEN
                                     SetNewStatus(xRec.Status::"In process",'');

                               END;
                                }
      { 17      ;1   ;Action    ;
                      Name=Approve;
                      CaptionML=[ENU=Approve;
                                 RUS=Утвердить];
                      Promoted=Yes;
                      PromotedCategory=Process;
                      PromotedOnly=Yes;
                      OnAction=BEGIN

                                   //'Approved';
                                   IF xRec.Status = xRec.Status::Approved THEN
                                     EXIT;

                                   IF NOT CheckUserAccess(xRec.Status::Approved) THEN
                                     EXIT;

                                   IF CONFIRM(textSet, FALSE, FORMAT(xRec.Status::Approved)) THEN
                                     SetNewStatus(xRec.Status::Approved,'');

                               END;
                                }
      { 18      ;1   ;Action    ;
                      Name=Decline;
                      CaptionML=[ENU=Decline;
                                 RUS=Отклонить];
                      Promoted=Yes;
                      PromotedCategory=Process;
                      PromotedOnly=Yes;
                      OnAction=BEGIN

                                   //'Declined';
                                   IF xRec.Status = xRec.Status::Declined THEN
                                     EXIT;

                                   IF NOT CheckUserAccess(xRec.Status::Declined) THEN
                                     EXIT;

                                   IF UserSetupHR THEN BEGIN
                                     CLEAR(dialConfirmationRejected);
                                     dialConfirmationRejected.SetVariablesPage(FORMAT(xRec.Status::Declined));

                                     IF dialConfirmationRejected.RUNMODAL = ACTION::OK THEN BEGIN
                                       SetNewStatus(xRec.Status::Declined, dialConfirmationRejected.GetVariablePage);
                                       //CurrPage.UPDATE;
                                       END;
                                     END
                                   ELSE BEGIN
                                     IF CONFIRM(textSet, FALSE, FORMAT(xRec.Status::Declined)) THEN BEGIN
                                       SetNewStatus(xRec.Status::Declined, STRSUBSTNO(textDeclinedUser, UserSetup.Employee));
                                     END;
                                    END;
                               END;
                                }
      { 23      ;1   ;ActionGroup;
                      Name=<ActionAttachments>;
                      CaptionML=[ENU=Attachments;
                                 RUS=Файлы] }
      { 24      ;2   ;Action    ;
                      Name=Attachments;
                      CaptionML=[ENU=Attachments;
                                 RUS=Вложения];
                      ApplicationArea=#All;
                      Promoted=Yes;
                      Image=Attach;
                      PromotedCategory=Report;
                      PromotedOnly=Yes;
                      OnAction=VAR
                                 RecRef@1000 : RecordRef;
                                 DocumentAttachmentDetails@1001 : Page 1173;
                               BEGIN

                                   RecRef.GETTABLE(Rec);
                                   DocumentAttachmentDetails.OpenForRecRef(RecRef);
                                   DocumentAttachmentDetails.RUNMODAL;
                               END;
                                }
      { 25      ;2   ;Action    ;
                      Name=Add file;
                      OnAction=VAR
                                 NVInStream@1000 : InStream;
                                 NVOutStream@1002 : OutStream;
                                 boolVar@1004 : Boolean;
                               BEGIN

                                   IF Status = Status::Approved THEN BEGIN
                                       MESSAGE(textApproved);
                                     EXIT;
                                   END;

                                   boolVar := UPLOADINTOSTREAM('Adding a file to a request','',' All Files (*.*)|*.*',"File Name",NVInStream);
                                   Rec."File Request".CREATEOUTSTREAM(NVOutStream);

                                   COPYSTREAM(NVOutStream,NVInStream);

                                   IF Rec."File Request".HASVALUE THEN
                                     Rec.MODIFY;
                               END;
                                }
      { 16      ;2   ;Action    ;
                      Name=[Save File ];
                      OnAction=VAR
                                 FileStreemIn@1000 : InStream;
                                 FileCodeutin@1001 : Codeunit 419;
                                 FileName@1002 : Text;
                                 PathFile@1003 : Text;
                                 ISdownload@1004 : Boolean;
                                 text001@1005 : TextConst 'ENU=The file is not attached to the application;RUS=Файл к заявке не прикреплен';
                                 text002@1006 : TextConst 'ENU=File saved!;RUS=Файл сохранен!';
                               BEGIN

                                   CALCFIELDS("File Request");
                                   IF NOT Rec."File Request".HASVALUE THEN BEGIN
                                       MESSAGE(text001);
                                       EXIT
                                     END;

                                   FileName  := "File Name";
                                   Rec."File Request".CREATEINSTREAM(FileStreemIn);
                                   PathFile := PathHelper.GetDirectoryName(FileName);

                                   ISdownload := DOWNLOADFROMSTREAM(FileStreemIn, 'Saving a file', PathFile,'',FileName);
                                   IF ISdownload THEN
                                     MESSAGE(text002);
                               END;
                                }
      { 22      ;    ;ActionContainer;
                      ActionContainerType=Reports }
      { 21      ;1   ;Action    ;
                      Name=Print Out of Office Day Count;
                      CaptionML=[ENU=Print Out of Office Day Count;
                                 RUS=Печать кол-во дней отсутствия];
                      OnAction=BEGIN

                                   Rec.FILTERGROUP := 0;
                                   Rec.SETRANGE("Entry No", "Entry No");
                                   IF NOT UserSetupHR THEN BEGIN
                                     Rec.FILTERGROUP :=2;
                                     Rec.SETRANGE("Employee No.", UserSetup.Employee);
                                   END;

                                   REPORT.RUNMODAL(REPORT::"Out of Office Day Count", TRUE, TRUE, Rec);
                               END;
                                }
    }
  }
  CONTROLS
  {
    { 1   ;    ;Container ;
                ContainerType=ContentArea }

    { 2   ;1   ;Group     ;
                Name=General;
                CaptionML=[ENU=General;
                           RUS=Общее];
                GroupType=Group }

    { 3   ;2   ;Field     ;
                SourceExpr="Entry No";
                Editable=EditablePage }

    { 4   ;2   ;Field     ;
                SourceExpr="Employee No.";
                Editable=EditablePage and UserSetupHR;
                OnValidate=BEGIN

                               CALCFIELDS(EmployeeInitials);
                           END;
                            }

    { 13  ;2   ;Field     ;
                SourceExpr=EmployeeInitials;
                Editable=FALSE }

    { 5   ;2   ;Field     ;
                SourceExpr="Start Date";
                Editable=EditablePage;
                OnValidate=BEGIN

                               //VALIDATE("Start Date");

                           END;

                ShowMandatory=True }

    { 6   ;2   ;Field     ;
                SourceExpr="Start Time";
                Editable=EditablePage;
                ShowMandatory=True }

    { 11  ;2   ;Field     ;
                SourceExpr=Description;
                Editable=EditablePage;
                ShowMandatory=True }

    { 10  ;2   ;Field     ;
                SourceExpr=Status;
                Editable=False }

    { 9   ;2   ;Field     ;
                SourceExpr="Reason Code";
                Editable=EditablePage;
                OnValidate=VAR
                             recordOutOfOffice@1000 : Record 50001;
                           BEGIN

                               //MESSAGE('OnValidate');
                               IF "Reason Code" = '' THEN
                                 VALIDATE(ReasonName, '')
                               ELSE  BEGIN
                                 CLEAR(recordOutOfOffice);
                                 recordOutOfOffice.GET("Reason Code");
                                 VALIDATE(ReasonName,recordOutOfOffice.Description);
                               END;
                           END;

                OnDrillDown=VAR
                              PageOutOfOffice@1000 : Page 50001;
                              recordOutOfOffice@1001 : Record 50001;
                            BEGIN

                                CLEAR(PageOutOfOffice);
                                CLEAR(recordOutOfOffice);
                                recordOutOfOffice.GET("Reason Code");
                                PageOutOfOffice.SETTABLEVIEW(recordOutOfOffice);
                                PageOutOfOffice.SETRECORD(recordOutOfOffice);
                                PageOutOfOffice.RUNMODAL;

                            END;

                ShowMandatory=True }

    { 14  ;2   ;Field     ;
                SourceExpr=ReasonName;
                Editable=FALSE }

    { 7   ;2   ;Field     ;
                SourceExpr="End Date";
                Editable=EditablePage;
                ShowMandatory=True }

    { 8   ;2   ;Field     ;
                SourceExpr="End Time";
                Editable=EditablePage;
                ShowMandatory=True }

    { 12  ;2   ;Field     ;
                SourceExpr="Rejection reason";
                Editable=False }

    { 15  ;1   ;Group     ;
                Name=File;
                GroupType=Group }

    { 26  ;2   ;Field     ;
                SourceExpr="File Name";
                Editable=false }

  }
  CODE
  {
    VAR
      UserSetup@1000 : Record 91;
      textError01@1001 : TextConst 'ENU=The start date must not be less than the working date!;RUS="Дата старта не должна быть меньше рабочей даты! "';
      UserSetupTrue@1002 : Boolean;
      EditablePage@1003 : Boolean;
      UserSetupHR@1005 : Boolean;
      dialConfirmationRejected@1006 : Page 50005;
      textSet@1007 : TextConst 'ENU=Change status to "%1"?;RUS=Изменить статус на "%1"?';
      textApproved@1008 : TextConst 'ENU=It is forbidden to change an application in the Approved status!;RUS=Изменять заявку в статусе Approved запрещено!';
      textDeclinedUser@1009 : TextConst 'ENU=Application canceled by user %1;RUS=Заявка отменена пользователем %1';
      PathHelper@1004 : DotNet "'mscorlib'.System.IO.Path";

    LOCAL PROCEDURE SetDefaultEmployee@1();
    BEGIN

        IF NOT UserSetupTrue THEN
          EXIT;

        IF UserSetup.Employee <> '' THEN
          "Employee No." := UserSetup.Employee;
    END;

    LOCAL PROCEDURE SettingVisibility@3();
    BEGIN

        EditablePage := NOT (Status = Status::Approved);
    END;

    LOCAL PROCEDURE SetNewStatus@2(NewStatus@1001 : Option;TextStatus@1000 : Text[250]);
    VAR
      text001@1002 : TextConst 'ENU=Status set "%1";RUS=Установлен статус "%1"';
    BEGIN

          xRec.Status := NewStatus;

          xRec."Rejection reason" := TextStatus;

          xRec.MODIFY;

          SettingVisibility;

          MESSAGE(text001, xRec.Status);
    END;

    LOCAL PROCEDURE CheckUserAccess@8(NewStatus@1000 : Option) AccessGranted : Boolean;
    BEGIN

          IF xRec.Status = xRec.Status::Approved THEN BEGIN
            MESSAGE(textApproved);
            AccessGranted := FALSE;
            EXIT;
          END;

          CASE NewStatus OF
            xRec.Status::"In process",
            xRec.Status::Declined:
              AccessGranted := TRUE;
            xRec.Status::Approved: BEGIN
              IF UserSetupHR THEN
                AccessGranted := TRUE
              ELSE
                BEGIN
                  AccessGranted := FALSE;
                  MESSAGE(textApproved);
                END;
             END;
           END;
    END;

    BEGIN
    END.
  }
}

